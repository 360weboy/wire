<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title>wire/cola bind test</title>

	<script src="../util/doh/runner.js"></script>
	<script src="../test-config.js"></script>

	<script type="text/javascript">
		define('test', function () {
			function Test() {}

			Test.prototype = {
				init: function () {}
			};

			return Test;
		});

		define('hub', function() {
			function Hub(primary, options) {
				this.primary = primary;
				this.options = options;
			}

			Hub.prototype = {
				addSource: function(adapter, options) {
					this.secondary = adapter;
					this.secondaryOptions = options;
				}
			};

			return Hub;
		});

		define('transform', function() {
			return function(input) {
				return input;
			};
		});

		function fail(dohd) {
			return function(e) {
				dohd.errback(e);
			};
		}

		require(['wire'], function (wire) {

			doh.register('wire/cola bind', [
				function shouldPassPluginOptions() {
					var dohd = new doh.Deferred();

					wire({
						cola: { module: 'wire/cola', success: true },
						hub: { create: 'hub' },
						test: {
							create: 'test',
							bind: {
								to: { $ref: 'hub' }
							}
						}
					}).then(
							function(context) {
								dohd.callback(context.hub.secondaryOptions.success);
							},
							function(e) {
								dohd.errback(e);
							}
					);

					return dohd;
				},
				function shouldFailWhenToNotSpecified() {
					var dohd = new doh.Deferred();

					wire({
						cola: { module: 'wire/cola' },
						test: {
							create: 'test',
							bind: {}
						}
					}).then(
						function(context) {
							dohd.errback('Should have failed without "to"');
						},
						function(e) {
							dohd.callback(!!e);
						}
					);

					return dohd;
				},
				function shouldFailWhenToInvalid() {
					var dohd = new doh.Deferred();

					wire({
						cola: { module: 'wire/cola' },
						test: {
							create: 'test',
							bind: {
								to: { $ref: 'missing' }
							}
						}
					}).then(
							function(context) {
								dohd.errback('Should have failed with invalid "to"');
							},
							function(e) {
								dohd.callback(!!e);
							}
					);

					return dohd;
				},
				function shouldFinishWiringWhenOptionsAreValid() {
					var dohd = new doh.Deferred();

					wire({
						cola: { module: 'wire/cola' },
						hub: { create: 'hub' },
						test: {
							create: 'test',
							bind: {
								to: { $ref: 'hub' }
							}
						}
					}).then(
							function(context) {
								dohd.callback(!!context.hub.secondary);
							},
							fail(dohd)
					);

					return dohd;
				},
				function shouldInjectQuerySelectorIntoOptions() {
					var dohd = new doh.Deferred();

					wire({
						cola: { module: 'wire/cola' },
						hub: { create: 'hub' },
						test: {
							create: 'test',
							bind: {
								to: { $ref: 'hub' }
							}
						}
					}).then(
							function(context) {
								dohd.callback(!!context.hub.secondaryOptions.querySelector);
							},
							fail(dohd)
					);

					return dohd;
				},
				function shouldProcessTransformFunctionsInBindings() {
					var dohd = new doh.Deferred();

					wire({
						cola: { module: 'wire/cola' },
						hub: { create: 'hub' },
						test: {
							create: 'test',
							bind: {
								to: { $ref: 'hub' },
								bindings: {
									foo: {
										node: '',
										prop: '',
										transform: { identity: 123 }
									}
								}
							}
						},
						identity: { create: 'transform' }
					}).then(
							function(context) {
								dohd.callback(!!context.hub.secondaryOptions.bindings.foo.transform);
							},
							fail(dohd)
					);

					return dohd;
				}

			]);

			doh.run();

		});
	</script>
</head>
<body>
	<div>
		<ul>
			<li id="list-template"><span class="name"></span></li>
		</ul>
	</div>
</body>
</html>